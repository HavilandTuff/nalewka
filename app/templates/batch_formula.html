{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="form-container">
            <div class="text-center mb-4">
                <h1><i class="bi bi-clipboard-plus text-primary"></i> Create New Batch</h1>
                <p class="text-muted">Add a new batch with ingredients and measurements</p>
            </div>

            <form method="POST" id="batch-form">
                {{ form.hidden_tag() }}

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            {{ form.batch_description.label(class="form-label") }}
                            {{ form.batch_description(class="form-control" + (" is-invalid" if form.batch_description.errors else ""), rows=4) }}
                            {% if form.batch_description.errors %}
                                {% for error in form.batch_description.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-3">
                            {{ form.liquor.label(class="form-label") }}
                            {{ form.liquor(class="form-select" + (" is-invalid" if form.liquor.errors else "")) }}
                            {% if form.liquor.errors %}
                                {% for error in form.liquor.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <h3 class="mb-3"><i class="bi bi-bottle"></i> Bottle Information</h3>
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            {{ form.bottle_count.label(class="form-label") }}
                            {{ form.bottle_count(class="form-control" + (" is-invalid" if form.bottle_count.errors else ""), type="number", min="0") }}
                            {% if form.bottle_count.errors %}
                                {% for error in form.bottle_count.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                            <div class="form-text">Number of bottles produced</div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="mb-3">
                            {{ form.bottle_volume.label(class="form-label") }}
                            {{ form.bottle_volume(class="form-control" + (" is-invalid" if form.bottle_volume.errors else ""), type="number", step="0.1", min="0.1") }}
                            {% if form.bottle_volume.errors %}
                                {% for error in form.bottle_volume.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="mb-3">
                            {{ form.bottle_volume_unit.label(class="form-label") }}
                            {{ form.bottle_volume_unit(class="form-select" + (" is-invalid" if form.bottle_volume_unit.errors else "")) }}
                            {% if form.bottle_volume_unit.errors %}
                                {% for error in form.bottle_volume_unit.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0"><i class="bi bi-list-ul"></i> Ingredients</h3>
                    <div>
                        <button type="button" class="btn btn-outline-success me-2" data-bs-toggle="modal" data-bs-target="#addIngredientModal">
                            <i class="bi bi-plus-circle"></i> New Ingredient
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="add-ingredient">
                            <i class="bi bi-plus-circle"></i> Add Ingredient
                        </button>
                    </div>
                </div>

                <div id="ingredients-container">
                    {% for ingredient_form in form.ingredients %}
                        {% include '_ingredient_entry.html' with context %}
                    {% endfor %}
                </div>

                <div class="mb-3">
                    {% if form.ingredients.errors %}<div class="text-danger">{{ form.ingredients.errors[0] }}</div>{% endif %}
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary me-md-2">
                        <i class="bi bi-arrow-left"></i> Cancel
                    </a>
                    {{ form.submit(class="btn btn-primary btn-lg") }}
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Template for new ingredient entries -->
<template id="ingredient-template">
    {% set ingredient_form = form.ingredients.append_entry().form %}
    {% include '_ingredient_entry.html' with context %}
</template>

<!-- Add Ingredient Modal -->
<div class="modal fade" id="addIngredientModal" tabindex="-1" aria-labelledby="addIngredientModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addIngredientModalLabel">Add New Ingredient</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="add-ingredient-form">
                    <div class="mb-3">
                        <label for="ingredient-name" class="form-label">Ingredient Name</label>
                        <input type="text" class="form-control" id="ingredient-name" required>
                        <div class="invalid-feedback" id="ingredient-name-error"></div>
                    </div>
                    <div class="mb-3">
                        <label for="ingredient-description" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="ingredient-description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-ingredient">Add Ingredient</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('ingredients-container');
    const addButton = document.getElementById('add-ingredient');
    const template = document.getElementById('ingredient-template');
    let ingredientCount = {{ form.ingredients|length }};

    addButton.addEventListener('click', function() {
        // Clone the template
        const clone = template.content.cloneNode(true);
        const newEntry = clone.querySelector('.ingredient-entry');

        // Update names and IDs to have the correct index
        newEntry.querySelectorAll('select, input, hidden').forEach(el => {
            el.name = el.name.replace('__prefix__', ingredientCount);
            el.id = el.id.replace('__prefix__', ingredientCount);
        });
        newEntry.querySelectorAll('label').forEach(el => {
            el.htmlFor = el.htmlFor.replace('__prefix__', ingredientCount);
        });

        container.appendChild(newEntry);
        ingredientCount++;
        updateRemoveButtons();
    });

    container.addEventListener('click', function(e) {
        if (e.target.closest('.remove-ingredient')) {
            e.target.closest('.ingredient-entry').remove();
            updateRemoveButtons();
        }
    });

    function updateRemoveButtons() {
        const entries = container.querySelectorAll('.ingredient-entry');
        entries.forEach(entry => {
            const removeBtn = entry.querySelector('.remove-ingredient');
            if (removeBtn) {
                // Hide the remove button if it's the only ingredient entry, otherwise show it.
                removeBtn.style.display = (entries.length <= 1) ? 'none' : 'block';
            }
        });
    }

    // Initial check for remove buttons when the page loads
    updateRemoveButtons();

    // Handle adding new ingredients via modal
    const saveIngredientButton = document.getElementById('save-ingredient');
    if (saveIngredientButton) {
        saveIngredientButton.addEventListener('click', function() {
            const nameInput = document.getElementById('ingredient-name');
            const descriptionInput = document.getElementById('ingredient-description');
            const name = nameInput.value.trim();

            if (!name) {
                document.getElementById('ingredient-name-error').textContent = 'Ingredient name is required';
                nameInput.classList.add('is-invalid');
                return;
            }

            // Get CSRF token from the form
            let csrfToken = null;
            const csrfTokenInput = document.querySelector('input[name="csrf_token"]');
            if (csrfTokenInput) {
                csrfToken = csrfTokenInput.value;
            } else {
                // Fallback: Try to get from meta tag if available
                const metaTag = document.querySelector('meta[name="csrf-token"]');
                if (metaTag) {
                    csrfToken = metaTag.getAttribute('content');
                }
            }

            if (!csrfToken) {
                console.error('CSRF token not found');
                document.getElementById('ingredient-name-error').textContent = 'Form error. Please refresh the page and try again.';
                nameInput.classList.add('is-invalid');
                return;
            }

            // Send request to create new ingredient
            fetch('/add_ingredient', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: new URLSearchParams({
                    'name': name,
                    'description': descriptionInput.value,
                    'csrf_token': csrfToken
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add the new ingredient to all ingredient select dropdowns
                    const ingredientSelects = document.querySelectorAll('select[name$="-ingredient"]');
                    ingredientSelects.forEach(select => {
                        const option = document.createElement('option');
                        option.value = data.ingredient.id;
                        option.textContent = data.ingredient.name;
                        select.appendChild(option);
                    });

                    // Clear the form and close the modal
                    document.getElementById('add-ingredient-form').reset();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addIngredientModal'));
                    modal.hide();

                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.role = 'alert';
                    alertDiv.innerHTML = `
                        Ingredient "${data.ingredient.name}" added successfully!
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.querySelector('.form-container').prepend(alertDiv);
                } else {
                    // Show error message
                    if (data.error) {
                        document.getElementById('ingredient-name-error').textContent = data.error;
                        nameInput.classList.add('is-invalid');
                    } else if (data.errors) {
                        // Handle form validation errors
                        if (data.errors.name) {
                            document.getElementById('ingredient-name-error').textContent = data.errors.name[0];
                            nameInput.classList.add('is-invalid');
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('ingredient-name-error').textContent = 'An error occurred. Please try again.';
                nameInput.classList.add('is-invalid');
            });
        });
    }

    // Clear validation errors when user types
    document.getElementById('ingredient-name').addEventListener('input', function() {
        this.classList.remove('is-invalid');
        document.getElementById('ingredient-name-error').textContent = '';
    });
});
</script>
{% endblock %}
