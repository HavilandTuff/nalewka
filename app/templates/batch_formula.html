{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="form-container">
            <div class="text-center mb-4">
                <h1><i class="bi bi-clipboard-plus text-primary"></i> Create New Batch</h1>
                <p class="text-muted">Add a new batch with ingredients and measurements</p>
            </div>
            
            <form method="POST">
                {{ form.hidden_tag() }}
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            {{ form.batch_description.label(class="form-label") }}
                            {{ form.batch_description(class="form-control" + (" is-invalid" if form.batch_description.errors else ""), rows=4) }}
                            {% if form.batch_description.errors %}
                                {% for error in form.batch_description.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            {{ form.liquor.label(class="form-label") }}
                            {{ form.liquor(class="form-select" + (" is-invalid" if form.liquor.errors else "")) }}
                            {% if form.liquor.errors %}
                                {% for error in form.liquor.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <h3 class="mb-3"><i class="bi bi-bottle"></i> Bottle Information</h3>
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            {{ form.bottle_count.label(class="form-label") }}
                            {{ form.bottle_count(class="form-control" + (" is-invalid" if form.bottle_count.errors else ""), type="number", min="0") }}
                            {% if form.bottle_count.errors %}
                                {% for error in form.bottle_count.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                            <div class="form-text">Number of bottles produced</div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="mb-3">
                            {{ form.bottle_volume.label(class="form-label") }}
                            {{ form.bottle_volume(class="form-control" + (" is-invalid" if form.bottle_volume.errors else ""), type="number", step="0.1", min="0.1") }}
                            {% if form.bottle_volume.errors %}
                                {% for error in form.bottle_volume.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="mb-3">
                            {{ form.bottle_volume_unit.label(class="form-label") }}
                            {{ form.bottle_volume_unit(class="form-select" + (" is-invalid" if form.bottle_volume_unit.errors else "")) }}
                            {% if form.bottle_volume_unit.errors %}
                                {% for error in form.bottle_volume_unit.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0"><i class="bi bi-list-ul"></i> Ingredients</h3>
                    <button type="button" class="btn btn-outline-primary" id="add-ingredient">
                        <i class="bi bi-plus-circle"></i> Add Ingredient
                    </button>
                </div>

                <div id="ingredients-container">
                    {% for ingredient_form in form.ingredients %}
                        {% include '_ingredient_entry.html' with context %}
                    {% endfor %}
                </div>

                <div class="mb-3">
                    {% if form.ingredients.errors %}<div class="text-danger">{{ form.ingredients.errors[0] }}</div>{% endif %}
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary me-md-2">
                        <i class="bi bi-arrow-left"></i> Cancel
                    </a>
                    {{ form.submit(class="btn btn-primary btn-lg") }}
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Template for new ingredient entries -->
<template id="ingredient-template">
    {% set ingredient_form = form.ingredients.append_entry().form %}
    {% include '_ingredient_entry.html' with context %}
</template>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('ingredients-container');
    const addButton = document.getElementById('add-ingredient');
    const template = document.getElementById('ingredient-template');
    let ingredientCount = {{ form.ingredients|length }};

    addButton.addEventListener('click', function() {
        // Clone the template
        const clone = template.content.cloneNode(true);
        const newEntry = clone.querySelector('.ingredient-entry');

        // Update names and IDs to have the correct index
        newEntry.querySelectorAll('select, input').forEach(el => {
            el.name = el.name.replace('__prefix__', ingredientCount);
            el.id = el.id.replace('__prefix__', ingredientCount);
        });
        newEntry.querySelectorAll('label').forEach(el => {
            el.htmlFor = el.htmlFor.replace('__prefix__', ingredientCount);
        });

        container.appendChild(newEntry);
        ingredientCount++;
        updateRemoveButtons();
    });

    container.addEventListener('click', function(e) {
        if (e.target.closest('.remove-ingredient')) {
            e.target.closest('.ingredient-entry').remove();
            updateRemoveButtons();
        }
    });

    function updateRemoveButtons() {
        const entries = container.querySelectorAll('.ingredient-entry');
        entries.forEach(entry => {
            const removeBtn = entry.querySelector('.remove-ingredient');
            if (removeBtn) {
                // Hide the remove button if it's the only ingredient entry, otherwise show it.
                removeBtn.style.display = (entries.length <= 1) ? 'none' : 'block';
            }
        });
    }

    // Initial check for remove buttons when the page loads
    updateRemoveButtons();
});
</script>
{% endblock %}